name: CI

on:
  push:

  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      RGBDS_VERSION: 0.7.0

    steps:
      - uses: actions/checkout@v4

      - name: Cache RGBDS
        id: cache-rgbds
        uses: actions/cache@v3
        with:
          path: rgbds/**
          key: ${{ runner.os }}-${{ env.RGBDS_VERSION }}-rgbds

      - name: Setup RGBDS
        if: steps.cache-rgbds.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://github.com/gbdev/rgbds/releases/download/v$env:RGBDS_VERSION/rgbds-$env:RGBDS_VERSION-win64.zip -OutFile rgbds-$env:RGBDS_VERSION-win64.zip
          Expand-Archive -Path rgbds-$env:RGBDS_VERSION-win64.zip -DestinationPath rgbds/

      - name: Make autogenerated files and ROM
        shell: pwsh
        run: |
          $env:Path += ";" + (Get-Item .).FullName + "\rgbds"
          make
  
      - name: Verify checksum
        shell: pwsh
        run: |
          $md5 = md5sum game.gbc
          if($md5 -ne "2206b879b38982ed995cdcbc927b7ba2 *game.gbc") {
              Write-Output "ROM Checksum Incorrect!"
              exit 1
          }